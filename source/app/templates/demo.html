{% extends "base.html" %}

{% block body %}
<div id="dashboard-explain">
  <table>
    <tr>
      <td>{% include 'template-yml.html' %}</td>
      <td>{% include 'template-yml-commentary.html' %}</td>
    </tr>
  </table>
  {% include 'attestations.html' %}
  <table>
    <tr>
      <td>{% include 'ci-yml.html' %}</td>
      <td>{% include 'ci-yml-commentary.html' %}</td>
    </tr>
  </table>
</div>
{% endblock %}

{% block js %}
<script type="text/javascript">
  $(window).ready(()=> {

    const scrollIntoView = (nodes, behaviour) => {
      // https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollIntoView
      if (nodes.length > 0) {
        const $first = nodes.first();
        // NOTE: Multiple behaviour:"smooth") calls cause problems.
        // Eg see https://bugs.chromium.org/p/chromium/issues/detail?id=1142270
        // The calling code must pass only _one_ behaviour="smooth"
        $first.get(0).scrollIntoView({
          behavior: behaviour, // See NOTE
          block: "center",     // Vertical
          inline: "start"      // Horizontal
        });
      }
    };

    // ====================================================
    // When you click on an attestation

    const scope = '#dashboard-explain';

    const $attestations = $(".attest", scope);

    $attestations.each(function() {
      const $attest = $(this);
      $attest.hover(function() {

        const highlight = (name, kind) => {
              $(`.${kind} .line`, scope).removeClass('lit');
              const nodes = $(`.${kind} .${name}`, scope);
              nodes.each(function() { $(this).addClass('lit'); });
              scrollIntoView(nodes, "instant");
        };

        // Highlight only that attestation
        $attestations.removeClass('lit');
        $attest.addClass('lit');

        // And the lines in the yml/commentary for that attestation
        const name = $attest.data("name");

        highlight(name, 'template-yml');
        highlight(name, 'template-yml-commentary');
        highlight(name, 'ci-yml');
        highlight(name, 'ci-yml-commentary');
      });
    });

    // ====================================================
    // When you click yml/commentary

    const setupHandler = (dee, dum) => {
      const kind = dee;
      $(`.${kind} .line`, scope).hover(function() {
        const $line = $(this);
        const classes = $line.attr('class').split(/\s+/);
        $.each(classes, function(_index, name) {
          //console.log(`name=${name}`);
          if (!["line", "lit", "n"].includes(name)) {
            //console.log(`name=${name} inside the if`);

            // Highlight attestation
            $('.attest', scope).removeClass('lit');
            $(`.attest[data-name='${name}']`, scope).addClass('lit');

            const highlight = (name, inner_kind) => {
              //console.log(`highlight(${name}, ${inner_kind})`);
              $(`.${inner_kind} .line`, scope).removeClass('lit');
              const nodes = $(`.${inner_kind} .${name}`, scope);
              //console.log(`count=${nodes.length}`);
              nodes.addClass('lit');
              if (inner_kind != kind) {
                const behaviour = (inner_kind == dum) ? "smooth" : "instant";
                scrollIntoView(nodes, behaviour);
              }
            };

            highlight(name, 'template-yml');
            highlight(name, 'template-yml-commentary');
            highlight(name, 'ci-yml');
            highlight(name, 'ci-yml-commentary');
          }
        });
      });
    };

    setupHandler("template-yml", "template-yml-commentary");
    setupHandler("template-yml-commentary", "template-yml");

    setupHandler("ci-yml", "ci-yml-commentary");
    setupHandler("ci-yml-commentary", "ci-yml");

  });
</script>
{% endblock %}
