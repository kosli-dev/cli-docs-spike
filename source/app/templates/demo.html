{% extends "base.html" %}

{% block body %}
  <table>
    <tr>
      <td>{% include 'template-yml.html' %}</td>
      <td>{% include 'template-yml-commentary.html' %}</td>
    </tr>
  </table>

  {% include 'attestations.html' %}

  <table>
    <tr>
      <td>{% include 'ci-yml.html' %}</td>
      <td>{% include 'ci-yml-commentary.html' %}</td>
    </tr>
  </table>
{% endblock %}

{% block js %}
<script type="text/javascript">
  $(window).ready(()=> {

    const scrollIntoView = (nodes) => {
      setTimeout(() => {
        nodes.first().get(0).scrollIntoView({behavior:"smooth", block:"center"});
      }, 100);
    };

    // ====================================================
    // When you click on an attestation

    const $attestations = $(".attest");

    $attestations.each(function() {
      const $attest = $(this);
      $attest.click(function() {
        console.log("attestation clicked");
        const name = $attest.data("name");
        console.log(`attestation = ${name}`);
        const highlight = (kind) => {
          const nodes = $(`.${kind} .${name}`);
          $(`.${kind} .line`).removeClass('lit');
          nodes.each(function() { $(this).addClass('lit'); });
          scrollIntoView(nodes);
        };
        // Highlight only that attestation
        $attestations.removeClass('lit');
        $attest.addClass('lit');
        // And the lines in the yml files for that attestation
        highlight('template-yml'); // For some unknown reason this call must come before...
        highlight('ci-yml');       // ...this call
      });
    });

    // ====================================================
    // When you click in template-yml
    // TODO: remove highlight on attestation

    const $template_yml_lines = $(".template-yml .line");
    $template_yml_lines.click(function() {
      const $line = $(this);
      const classes = $line.attr('class').split(/\s+/);
      $.each(classes, function(index, name) {
        if (name != "line" && name != "lit") {

          // Highlight attestation
          $('.attest').removeClass('lit');
          $(`.attest[data-name='${name}']`).addClass('lit');

          // Highlight template-yml
          $('.template-yml .line').removeClass('lit');
          $(`.template-yml .${name}`).addClass('lit');

          // Highlight ci-yml
          $('.ci-yml .line').removeClass('lit');
          const nodes = $(`.ci-yml .${name}`);
          nodes.addClass('lit');
          scrollIntoView(nodes);
        }
      });
    });

    // --------------------------------
    // When you click in template-yml commentary
    // TODO...

    // ====================================================
    // When you click in ci-yml
    // TODO: remove highlight on attestation

    const $ci_yml_lines = $(".ci-yml .line");
    $ci_yml_lines.click(function() {
      const $line = $(this);
      const classes = $line.attr('class').split(/\s+/);
      $.each(classes, function(index, name) {
        if (name != "line" && name != "lit") {

          // Highlight attestation
          $('.attest').removeClass('lit');
          $(`.attest[data-name='${name}']`).addClass('lit');

          // Highlight ci-yml
          $('.ci-yml .line').removeClass('lit');
          $(`.ci-yml .${name}`).addClass('lit');

          // Highlight template-yml
          $('.template-yml .line').removeClass('lit');
          const nodes = $(`.template-yml .${name}`);
          nodes.addClass('lit');
          scrollIntoView(nodes);
        }
      });
    });

    // --------------------------------
    // When you click in ci-yml commentary
    // TODO...

  });
</script>
{% endblock %}
