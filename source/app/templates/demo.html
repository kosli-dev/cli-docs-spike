{% extends "base.html" %}

{% block body %}
  <table>
    <tr>
      <td>{% include 'template-yml-commentary.html' %}</td>
      <td>{% include 'template-yml.html' %}</td>
    </tr>
  </table>
  {% include 'attestations.html' %}
  <table>
    <tr>
      <td>{% include 'ci-yml-commentary.html' %}</td>
      <td>{% include 'ci-yml.html' %}</td>
    </tr>
  </table>
{% endblock %}

{% block js %}
<script type="text/javascript">
  $(window).ready(()=> {

    const scrollIntoView = (nodes) => {
      //setTimeout(() => {
      if (nodes.length > 0) {
        const $first = nodes.first();
        $first.get(0).scrollIntoView({behavior:"smooth", block:"center"});
        //$first.scrollLeft(0); // BUG: Not working
      }
      //}, 100);
    };

    // ====================================================
    // When you click on an attestation

    const $attestations = $(".attest");

    $attestations.each(function() {
      const $attest = $(this);
      $attest.click(function() {

        const highlight = (name, kind) => {
              $(`.${kind} .line`).removeClass('lit');
              const nodes = $(`.${kind} .${name}`);
              nodes.each(function() { $(this).addClass('lit'); });
              scrollIntoView(nodes);
        };

        // Highlight only that attestation
        $attestations.removeClass('lit');
        $attest.addClass('lit');

        // And the lines in the yml/commentary for that attestation
        const name = $attest.data("name");

        highlight(name, 'template-yml');
        highlight(name, 'template-yml-commentary');
        highlight(name, 'ci-yml');
        highlight(name, 'ci-yml-commentary');
      });
    });

    // ====================================================
    // When you click yml/commentary

    const setupHandler = ($nodes) => {
      $nodes.click(function() {
        const $line = $(this);
        const classes = $line.attr('class').split(/\s+/);
        $.each(classes, function(_index, name) {
          console.log(`name=${name}`);
          if (!["line", "lit", "n"].includes(name)) {
            console.log(`name=${name} inside the if`);

            // Highlight attestation
            $('.attest').removeClass('lit');
            $(`.attest[data-name='${name}']`).addClass('lit');

            const highlight = (name, kind) => {
              console.log(`highlight(${name}, ${kind})`);
              $(`.${kind} .line`).removeClass('lit');
              const nodes = $(`.${kind} .${name}`);
              console.log(`count=${nodes.length}`);
              nodes.addClass('lit');
              scrollIntoView(nodes);
            };

            highlight(name, 'template-yml');
            highlight(name, 'template-yml-commentary');
            highlight(name, 'ci-yml');
            highlight(name, 'ci-yml-commentary');
          }
        });
      });
    };

    setupHandler($(".template-yml .line"));
    setupHandler($(".template-yml-commentary .line"));

    setupHandler($(".ci-yml .line"));
    setupHandler($(".ci-yml-commentary .line"));

  });
</script>
{% endblock %}
